# FaceDeformation



《数值分析与算法》
人脸图像扭曲变形报告






自61 张嘉玮
2016011528
2018/11/10




目录
1.需求分析和基本原理 ……………………………………………………………………2
1.1映射方案…………………………………………………………………………… 2
1.2插值方案…………………………………………………………………………… 4
1.3人脸特征点检测…………………………………………………………………… 7
2.方案设计与实现……………………………………………………………………………7
2.1方案设计   …………………………………………………………………………7
2.2关键环节实现   ……………………………………………………………………12
2.2.1 TPS求解映射关系 …………………………………………………………12
2.2.2  B样条 ……………………………………………………………………13
2.2.3求解生成图 …………………………………………………………………16
2.2.4特征点识别  ……………………………………………………………… 16
3.关键环节演示  …………………………………………………………………………17
3.1 TPS …………………………………………………………………………………17
3.2 B样条 ………………………………………………………………………………19
3.3  B样条+TPS………………………………………………………………………20
3.4 方案比较 ………………………………………………………………………… 21
4.误差分析 …………………………………………………………………………………22
4.1舍入误差  …………………………………………………………………………22
4.2方法误差  …………………………………………………………………………22
4.2.1最近领插值  ……………………………………………………………… 22
4.2.2双线性插值   ………………………………………………………………23
4.2.3双三次插值   ………………………………………………………………24
4.2.4Lanczos插值算法  ………………………………………………………… 25
4.2.5反距离插值Inverse Distance Weighted  ……………………………………26
4.3插值方案的比较   …………………………………………………………………27
5.问题及收获       ……………………………………………………………………… 30
6.参考文献及资料   ……………………………………………………………………… 31










关键词：人脸变形，TPS，B样条，图像插值，人脸特征点检测。

1.需求分析和基本原理
本次人脸图像扭曲变形是基于人脸特征点进行的，因此，可将任务分为两个大的步骤，第一步找到特征点以及非特征点的映射关系，第二步使用插值等方法进行像素值的求解。而对应的需求也将包括以下两个方面。
1.1映射方案
人脸特征点的关系会因不同的人脸以及像素点的位置等特点，使得原特征点到目标特征的相似性，要找到一种连续的映射过程。两种主要的映射方法是径向基函数映射和B样条映射。
径向基函数的主要步骤有下面三部：
A.获得原人脸和目标人脸上具有代表性的位置点，即特征点。特征点之间一一对应。
B.使用径向基函数和特征点建立原人脸和目标人脸之间的映射关系。
C.利用得到的映射关系，找到每一个非特征点的在目标图当中的位置，并将像素赋予对应的位置。
而在生物图像变形方面，一般选取下面的径向基函数：
Duchon的薄板样条：
对应的方法称作薄板样条（TPS）算法。
此方案看似看似映射关系很难求解，但是思路明晰，目标明确。相比而言，另一种使用较为广泛的变形方案时基于离散的B样条，对图像进行变形。
B样条变形有其自身的特点，特征点的移动，只影响其附近的点做响应的变化。相比而言，在薄板样条的方案当中，控制点的移动会影响所有像素点的移动。B样条的步骤主要如下：
A.根据特征点的移动确定选定的控制点的移动量。
B.根据每一个点相对于特征点的位置，确定其位移量。
C.将这些位移作用到原图像的每一个点，便可以得生成的图像。
B样条方法看似简单，但是在基于特征点的变形上，由于特征特征点的位置不均匀，分散过于零散。在这样的情况下，部分特征点特别是眼睛等细节位置的变化会被忽略，因此存在很大的潜在误差。
以上两种方法共同存在的一个问题是，在变化过程中，会出现：
A.原图当中有多个点对应到目标图上的同一个点，这样就会造成像素点的重叠，即信息的丢失。
B.目标图像当中会有很大的空洞没有对应的原图的像素值对应过来，这样会导致最终图像上会出现“裂痕”或者“空洞”。
以上两种问题在实验过程当中，都发生了。而为了解决以上的问题，采取了下面的解决方案：
A.映射方向不做改变，对于空缺的位置，找到和他最“最相似”的像素值填补，即用其周围的像素值进行填补。
B.改变映射方向。以上都是正向的映射，而当选取方向映射时，就能很好的避免上面两种情况的发生。即对于目标图像上的每一个点，通过反解之前得到的映射关系，就会得到其在目标图像当中的位置。进而用该位置周围的正数点，插值得到其对应的像素值。
如果能将这两种方案的优点结合起来，便可以得到图像变形自然，并且细节信息也可以得到变形的结果。因此可以将原图先进行一次B样条变形，得到脸部轮廓的图像，然后将这张图片在进行一次TPS变形，便可以得到轮廓以及细节点都得到有效变化的人脸图片。
在方案选择时，对两种变形方案都予以实现，发现薄板样条方案更加符合脸的形状，B样条会出现扭曲走样以及变化不连续等问题，在最终程序当中也都予以了显示，以比较插值结果。
1.2插值方案
之所以需要插值，主要在进行逆映射求解时，求解出来的位置很有可能是浮点数，这对于数字图像是没办法解决的，这是，只能根据其周围像素值的表现，使用插值的方法，求得其像素值。
在介绍这些插值方案之前，先定义下面的符号
定义：为待求像素的坐标，i，j为整数，x，y为小数。
在数字图像处理当中，能够使用的插值方法有很多，基于本课程的主要任务便是插值，因此尝试和实现了多个插值算法，主要包括下面五种：
A.最近邻插值
最近邻插值是较为简单的插值方案，不需要计算，只需将求得的坐标四舍五入即可。比如x<0.5，y>0.5，则点的像素值即为所求像素值。
此方法计算量小，但是会造成插值生成的图像“不连续”，在像素变化比较大的区域，出现明显的锯齿状等等。
B.双线性插值
双线性插值又称作双线性内插。核心思想是在两个方向上分别进行一次线性插值。基于以上的定义，则此方法可表示为：

C.双三次插值
双三次插值是一种较为复杂的插值方案，它能构造出比以上两种方案都要平滑的图像边缘。具体思路是，对于任意一点的像素值，通过其周围16个点的像素值，进行加权插值得到。
三次插值的基函数：
   
由此式对得到的权值对图像像素值进行加权平均即可。
D.Lanczos插值
Lanczos算法是一种将对称矩阵通过正交相似变换成对称三角矩阵的算法。是在图像重采样和滤波当中使用较多的一种算法。当选择插值窗口为4*4时，Lanczos窗口定义如下：

插值公式：

E.反距离插值Inverse Distance Weighted
反距离插值算法的权重主要依赖反距离的幂值，主要思想是控制点对被插值点的影响与距离成反比。不同的幂次强调次影响的大小。
在本次作业当中，选取的幂次为1，控制点为4.
加权基函数：



五种方法各有特点，其中最近邻计算量最小，但会出现阶梯等问题。双线性较最近邻，得到的图像相对平滑，当中没有考虑到图像的“变化率”。双三次能够有效的解决以上两种方法带来的弊端，但是由于其计算量较大，计算过程会较慢。Lanczos插值在提高图像的分辨率上有较大的作用，次算法和双三次插值大致一致，但是插值速度和二次插值相仿。反距离插值的优点是可以根据不同的情况确定不同的幂次，这在一些地图的放缩当中使用较为广泛。为了对比五种算法的区别和各自的特点，对五种算法都进行了实现。
1.3人脸特征点检测
为了实现程序的可扩展性，对附加题进行了简单的实现。由于OpenCV人脸识别算法准确率受限，人脸识别这一环节使用了于仕祺老师开源的的人脸检测库，其识别速度以及识别准确率远高于OpenCV自带的人脸检测算法。
2.方案设计与实现
2.1方案设计
程序运行效果图
【TPS+双三次】





【B样条（小）+最近领】

【B样条（大）+双线性】

【B样条+TPS+双线性】


方案设计：
整体运行结果如上图所示。可以将界面分为上下两个板块。上面主要是对原图，目标图，以及生成的图片进行的显示。下面是一些操作的按钮。
图像的显示根据窗口大小进行了调整，但是存储以及进行操作的都是原图。生成的图为了观察其细节，没有对其进行放缩，使用者可以通过滑动观察细节和效果。
第二行左边是将读取到的或者识别到的特征点在图像显示，包括原图以及目标图。显示的前提是原图或者目标图已经读取，特征点也已经通过读取或者是别的方式获得；若不满足这两个特点，程序会有响应的提示。
第二行中间是一些选项：
【变形函数】变形函有TPS和B样条两种。而B样条有分为两种，一种是基于“双线性”思想的变形，其变形程度小，故称之为B样条（小）；另一种是基于“最近领”思想的变形，其变形程度大，故称之为B样条（大）；B样条+TPS,先将图片进行一次B样条变换，得到脸部轮廓的变形，在进行一次TPS变形，得到细节（眼睛）的变形。
【变形方向】是在进行TPS变形时，会有两个方向，正向和反向。默认选项是效果更好的反向变换。正向变形无需插值，即只有最近邻。
【图像调整】这里面的选项主要是考虑到TPS变形时，由于特征点的位置以及脸部的大小进行适当的调整。以获得更加合适的效果和变形结果。
【逆向插值方式】插值方法有五个，分别是最近邻、双三次、双线性。

第二行右边的按钮，对应进行不同的操作。
【原图】对原图的操作主要有三个，读取图片，读取特征点，识别特征点。在读取文件时若中途退出或者读取失败，程序会有相应的提示。而特征点的识别前提是已经读取了图片。若尚未读取，会有相应的提示说明。
【目标图】对目标图的操作更原题一样，对应的容错性设置更原图相似。
【生成图】主要有两个操作：根据所选参数已经方式，生成对应的图像同时进行显示。该过程需要很多数据，若所需数据不足或者参数有误，都会给予相应的提示说明。对图像的保存会允许使用者选取保存路径，而图像名字则是随机生成的三位数来命名的。保存图像若失败，会有相应的提示说明。
2.2关键环节实现
2.2.1TPS求解映射关系
TPS求解映射关系是首先得到如下方程组：

其中：	K是由径向基函数得到的68*68矩阵。

O为3*3的0矩阵。a,b是要求解的系数，为71*1。x,y分别为目标特征点的横纵坐标。
TPS薄板样条变换的关键便是求解一个71*71维的线性方程组，由于数值很大，位数很多，一般的解方程方法很难求解这种大矩阵。在进行一番尝试和比较后，选择了高斯消元求逆矩阵的方法。基本原理如下：



便可以求出系数矩阵。
正弦变换和方向变换的过程对称，求解线性方程组的方法一样。
高斯消元虽然对大矩阵较好，但是只符合有唯一解的情况。当特征点选取的不好，方程有两个及以上数量个解时，此方法就会无效。本程序对这种情况也做了容错处理，会提示使用者对特征点、目标图或者原图做出调整。
2.2.2B样条
B样条根据控制点的移动来确定每一个点的位移，因此B样条的的过程可分为以下几个步骤：
步骤一：选取合适的B样条控制点。
步骤二：根据68个特征点的位移确定所有B样条控制点的位移。
第三步：根据控制点的位移确定每一个像素点的位移，进行像素幅值。
步骤一：
对于二维离散的图片，其B样条控制点一般通过网格点来确定，即用网格结点作为查找结点。网格点选取的有以下几个因素需要考虑：
A、网格点选取不能太大。当网格之间的距离选取的过大，这样会在一个网格当中有若干特征点，即有多个网格点的移动信息“降维”到了其周围少数几个特征点的位移，等同于信息丢失。
B、同样，网格点的选取还应该使得大多数特征点的位移不要超过网格宽度，即网格点选取不能太小。
显然，以上两个要求相互矛盾，因此只能通过调节网格大小，已达到一种平衡，使得两种要求的平衡点。
步骤二：
求解控制点的位移。B样条控制点的位移无法直接得到，只能通过已知的特征点的位移来求。
由于不同图片人脸（特征点）的位置不一样，在求解特征点位移之前先要使得人脸位置对齐，并且将目标人脸进行放缩，和原人脸差不多大小。然后求出特征点的位移。
从特征点位移到控制点的位移，这一步至关重要。其近似效果直接影响最终的变形效果，理想的效果是根据控制点的位移反求特征点的位移时，应该得到同样的特征点位移，显然，这一步无法精确得到，只能通过近似的方法求解。我主要使用了一下两种方法：
A.“最近领近似”。这一方法效率高但是误差太大。即每一个特征点的位移近似到其最靠近的控制点的位移。这和上面的理想的而结果差别较大，最终的变形结果较差。
B.“反距离”加权。这一方法的灵感来源于反距离插值。每一个特征点的位移控制其周围四个控制点的位移，距离特征点越近，其得到的移动量的权值也会越大。显然，这一种方法比“最近领近似”要好，但是也有这较大的误差。

步骤三：
根据控制点位移求每一个像素的位移。选取三次B样条曲线进行求解，每一个点的位移量和其周围16个控制点的位移量有关。
三次B样条曲线基函数：

对于任意一个像素位移，记网格大小为N，同时记：，网格点（i,j）处的位移记做，则（x,y）点的位移为：



在求取位移时，同样有两种方法：
A.正向。即用上面的原值直接求解原图每一点在生成的图像当中的位置。该方法符合常规思路，但是同TPS正向变换一样，会出现空缺的位置，因此需要补全。但这样造成的视觉效果较很差，即使补全，也会会出现一些纹路。
B.反向。即看目标图上的每一个点在原图当中的什么位置。显然，该方法很难精确的求解，故只能用近似的方法。近似的方法基于这样的假设：每一个点的位移量相对较小，因此上面的（x,y）就可以用生成图像上的（x,y）来代替，进而进行近似求解。即：

2.2.3求解生成图
生成图的求解主要在于求解每一像位置的像素值。
在正向求解时，会出现空洞或者裂痕。而使用最近领的思想，将这些位置用其周围的像素值进行赋值。为了使得图像不出现“线条”，交替使用其左边或者上边的像素值进行替代。
对于反向求解，首先找到目标图坐标在原图当中对应的做坐标，然后根据所选择的插值方法，进行插值。然后将插值结果付给对应的坐标。
2.2.4特征点识别
在使用了于仕祺老师的开源库之后，可以较为容易检测到目标图的人脸特征点位置。
库连接【https://github.com/ShiqiYu/libfacedetection】
3.关键环节演示
3.1TPS
A.正向最近领插值

B.逆向最近领

C.逆向双线性


D.逆向双三次

E.逆向Lanczos插值

F.反距离插值

3.2B样条
A.最近领插值

B.双三次

C.双线性

3.3B样条+TPS

（与只有TPS的图像相比较）



3.4方案比较
两种方案各有优点。TPS作为为一“精确”的映射关系，其对人脸的特征点的映射关系可以精确的求得，即其根据目标图的特征点生成的图，和生成图特别像。但是其缺点是，对于原图上的每一个点都要随着特征点的移动而移动，即使其距离特征点很远，进而导致生成图当中出现没有像素信息的白色区域。
而B样条生成的图片就可以没有空缺，其原因在于B样条只改变其基函数不为零的区域，对于距离人脸（特这点）较远的地方，是不会发生移动，因此，这样产生的图片便没有空缺的地方。但是B样条由于把特征点的移动量转移到了控制点上，在这一过程当中丢失了许多信息，因此，其最终得到的生成的图片，其和目标图的相似度不如TPS得来的生成图。
而将两种变形手段结合起来的B样条+TPS变形方法，是先根据原始图像进行一次B样条变形，接着在生成的图像上，进行一次特征点的识别，将识别的特征点与目标图像在进行一次TPS的变形，这样的结果是能够减小图像上没有信息（空白）的区域。同时较适合用于脸部角度有较大差别的变形图像。因为只进行TPS变化，通常是特征点包围的区域当中有较好的变形，但是脸部轮廓以及眼眶上面的部分还是原来的角度 ，因此图片距离真实的情况较远。而如果在将B样条和TPS结合起来，等同于变形两次，便可以减小TPS脸部角度问题。即B样条可以根据脸部轮廓之内的点，将脸部轮廓附近的一些曲点变形到对应的位置，进而使得变形结果更加自然。
4.误差分析
4.1舍入误差
舍入误差主要是由于计算机存储数据位数所限导致。在进行计算时，使用的类型皆为double型，有效数字有15位，对于像素值，最大为三位数，则由于double型数据长度导致的输入误差为。
另一个舍入误差则来自像素值本身存储导致的误差。由于像素值本身只能是整数，在幅值时进行了四舍五入，这一环节的舍入误差为0.5。
将上面两个环节的误差相加，可得整体的舍入误差为0.5。
有这个情况可以看出，数字图像的本身的性质，导致了舍入误差在0.5。而计算机在计算时导致的舍入误差，对结果的影响很小。
4.2方法误差
4.2.1最近领插值
在最近邻插值时，点坐标采用了四舍五入的近似关系。误差为：


其中，为点四舍五入后的坐标。
两边取绝对值，得：
	根据四舍五入的性质，得：

设：，则误差满足：

根据数字图像的特点，其每一个通道的值在0到255之间，则。即最近邻插值的误差上限为：。
4.2.2双线性插值
双线性插值的基本原理是进行了三次一维的线性插值。在进行分析之前，先设，。
第一步，在X方向进行插值，得到（x,j）点像素值。

第二步，在X方向进行插值，得到（x,j+1）点像素值。
同第一步方法，可得:

第三步，沿Y方向进行插值，得到（x,y）点像素值。

则双线性对应的误差为：

4.2.3双三次插值
同双线性插值，双三次插值可分解为两个方向的一维插值。同样令：，。
双三次插值等同于在X方向做四次一维插值，在Y方向做一次一维插值。
X方向的第一次插值的截断误差：

同理的X方向的另外三次插值带来的截断误差：
，，
最后一次在Y方向的插值带来的误差：

则双三次带来的总误差为：

4.2.4Lanczos插值算法
同双三次插值，Lanczos插值可分解为两个方向的一维插值。同样令：，。
在X方向做四次插值，在Y方向做一次插值。
X方向的第一次插值：

其中L为前面介绍的Lanczos插值核：

求得：
	则：
同理，在X方向的另外三次插值的误差为：
，，
接着在Y方向进行最后一次插值：

则Lanczos插值插值的总误差为：

4.2.5反距离插值Inverse Distance Weighted
反距离插值的误差分析方法同双线性，但又区别于以上几种插值方法的多次一维插值的思路。同样，令，。
第一步，在X方向进行插值，得到（x,j）点像素值。

其中，由反距离插值的基函数求得：

可得：

反距离插值的方法误差明显小于前面的双线性的方法误差。这也在下面的插值结果当中有直观的感受。

4.3插值方案的比较
五种插值方法各有各的特点以及缺点。最近邻插值速度快，但是图像在放大之后会看到明显的锯齿状过渡，同时，由误差分析可得，最近邻对应的阶段误差也是很大的。
双向性插值能较好的避免锯齿的出现，同时计算速度也适中。相比而言，双向性虽然误差小，能避免锯齿的出现，但是其计算速度慢，这在一些速度要求高的应用上是不能接受的。
Lanczos插值算法和反距离插值Inverse Distance Weighted在实际应用当中更多的用于图像放缩和滤波当中，以提高图像 的分辨率。而像这种用于单点的插值，其实更多的使用上面介绍的三种线性插值算法。
【基于TPS】
正向

最近邻

双线性

双三次


反距离

Lanczos



通过观察不难看出，在虹膜附近，最近领的对比度比较高，但过渡不均匀。相比而言，双线性和双三次的过渡比较均匀，但是虹膜附近的对比度有所损失。另外反距离的效果是由于上面三种的，不仅对比度得到了保留，另外过渡也很均匀。Lanczos插值方法过渡均匀，但出现了纹波现象，这也是由于其插值过程需要的点更多，并且根据其权值，有增加对比度的作用，进而产生了纹波。就眼睛这一位置来看，反距离插值与另外三种插值相比，有更好的插值效果。
5.问题及收获
5.1B样条花费大量时间实现，但是效果不尽人意
在大作业的第一周，在对两种方法进行分析对比之后，感觉B样条更符合变与不变的思路，因此选取了B样条。在搞B样条时花费了大量的时间，但和目标图的相似度远不及TPS的而结果。最后分析也发现，B样条适合一些小的变化，对于一张脸有68个特征点，而且分布不均匀，这对于B样条其实是不太适合的。相反，TPS在理论上，可以有任意多个控制点。
5.2TPS解方程
由于理论上方程时又觉得，因此便直接使用Gaussion消元的方法求解，结果总是NaN。后来发现是数值超过了double型数据的范围，这也是第一次遇到这种超范围的情况，然我对计算机离散有限位存储数据有了新的认识。之后尝试了LU分解，同样失败。在和同学交流后，发现像这种比较大的求解，需要通过矩阵求逆，然后又回归到Gaussion消元求逆上，进而得出了想要的结果。
5.3收获
首先是要多交流，刚开始自己单独搞，思路单一，遇到困难跳不出来，和同学交流后，便有了很多新的想法，受益匪浅。
锻炼了自己的编程能力。由于大二一年基本上是在用python和MATLAB，导致自己对C++的严谨的代码结构遗忘了许多。而这次大作业，让我对C++得到了充分的回顾。同时也感受到了C++运算速度的强大。
对离散的插值问题有了更加深入的理解和掌握。

6.参考文献及资料
[1].李庆杨,王能超,易大义. 数值分析[M].第五版.北京：清华大学出版社.2008.
[2].陈秋燕,殷福亮.基于 博板样条的人脸变形计数[J].通信理论与信号处理学术年会论文集.2010.
[3].Mono_玉鹏.如何使用于开源库ibfacedetection[EB/OL].
https://blog.csdn.net/mono_1032290547/article/details/78912548.2017.

	

1.语言：C++
2.系统：Window10 企业版
3.编译：VS 2012
4.OpenCV：3.0.0
5.GUI编程：VS2012+Qt Visual Stdio Tools，版本：5.2.0
6.读取文件限制为英文路径
7.源码说明：
            main.cpp：主文件
            facedistorted.h/.cpp：人脸变形类
            Interpolation.h/.cpp：插值
            BSplit.h：B样条
            TPS.h：薄板样条插值
            AttrV：包含打多少的底层函数（attribute）
            ui_facedistorted.h：界面生成文件
			
8.可执行文件说明：
		我在两个室友的电脑上测试了EXE文件，有一个室友的可以，另一个的显示0*000007程序不可执行。
		我把提示缺少的dll文件都放了进去，若助教那边要是不可执行的话，我带电脑去主楼那边验收吧。
	
